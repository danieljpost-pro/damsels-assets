{% extends "base.html" %}

{% block title %}{{ config.title }} - Enter the Realm{% endblock %}

{% block content %}
<!-- Hamburger Menu -->
<nav class="hamburger-menu">
    <button class="hamburger-menu__toggle" id="menu-toggle" aria-label="Toggle menu">
        <span class="hamburger-menu__bar"></span>
        <span class="hamburger-menu__bar"></span>
        <span class="hamburger-menu__bar"></span>
    </button>
    
    <div class="hamburger-menu__dropdown hidden" id="menu-dropdown">
        <div class="hamburger-menu__item">
            <label class="theme-toggle">
                <input type="checkbox" id="theme-toggle-checkbox">
                <span class="theme-toggle__slider"></span>
                <span class="theme-toggle__label">Dark Mode</span>
            </label>
        </div>
        <button class="hamburger-menu__item hidden" id="menu-preferences">
            ‚öôÔ∏è Activity Preferences
        </button>
        <button class="hamburger-menu__item hidden" id="menu-reload-room">
            üîÑ Reload Room
        </button>
        <button class="hamburger-menu__item hidden" id="menu-share-room">
            üì≤ Share Room (QR)
        </button>
        <button class="hamburger-menu__item hamburger-menu__logout" id="menu-logout">
            üö™ Log Out
        </button>
    </div>
</nav>

<main class="welcome">
    <div class="welcome__container">
        <h1 class="welcome__title">{{ config.title }}</h1>
        <p class="welcome__tagline">{{ section.content | safe }}</p>
        
        <!-- Step 1: Login/Register -->
        <section id="step-login" class="step step--active">
            <form class="login-form" id="login-form">
                <div class="login-form__field">
                    <label for="username" class="login-form__label">Choose Your Name</label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        class="login-form__input"
                        placeholder="Enter username..."
                        required
                        autocomplete="username"
                        minlength="2"
                        maxlength="24"
                    >
                </div>
                
                <div class="login-form__field">
                    <label for="password" class="login-form__label">Password</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        class="login-form__input"
                        placeholder="Enter password..."
                        required
                        autocomplete="current-password"
                        minlength="4"
                    >
                </div>
                
                <div class="login-form__error" id="login-error"></div>
                
                <div class="login-form__buttons">
                    <button type="submit" class="login-form__submit" data-action="login">
                        <span class="btn-text">Login</span>
                        <span class="btn-loading">Authenticating...</span>
                    </button>
                    <button type="button" class="login-form__register" id="btn-register">
                        <span class="btn-text">Register</span>
                        <span class="btn-loading">Creating...</span>
                    </button>
                </div>
            </form>
        </section>
        
        <!-- Step 2: Player Selection -->
        <section id="step-player" class="step">
            <div class="player-header">
                <span class="player-header__user" id="current-user"></span>
                <button class="player-header__logout" id="btn-logout">Logout</button>
            </div>
            
            <h2 class="step-title">Choose Your Identity</h2>
            
            <div class="player-list" id="player-list">
                <!-- Player cards will be inserted here -->
            </div>
            
            <div class="player-create">
                <form class="player-form" id="player-form">
                    <div class="player-form__field">
                        <input 
                            type="text" 
                            id="player-name" 
                            name="player-name" 
                            class="login-form__input"
                            placeholder="Create new player identity..."
                            minlength="2"
                            maxlength="24"
                        >
                        <button type="submit" class="player-form__submit">+ Create</button>
                    </div>
                    <div class="login-form__error" id="player-error"></div>
                </form>
            </div>
        </section>
        
        <!-- Step 3: Room Selection -->
        <section id="step-room" class="step">
            <div class="room-header">
                <span class="room-header__player" id="current-player"></span>
                <button class="room-header__back" id="btn-back-player">‚Üê Change Player</button>
            </div>
            
            <!-- Accept Invitation Section -->
            <div class="invitation-section hidden" id="invitation-section">
                <form class="join-form" id="invitation-form">
                    <div class="join-form__header">
                        <span class="room-option__icon">‚úâÔ∏è</span>
                        <span class="room-option__title">Accept Invitation</span>
                    </div>
                    <div class="join-form__field">
                        <input 
                            type="text" 
                            id="invitation-token" 
                            name="invitation-token" 
                            class="login-form__input join-form__input"
                            placeholder="Enter invitation token..."
                        >
                        <button type="submit" class="join-form__submit">Join</button>
                    </div>
                    <div class="login-form__error" id="invitation-error"></div>
                </form>
                <div class="room-divider"><span>or</span></div>
            </div>
            
            <div class="room-options">
                <button class="room-option" id="btn-create-room">
                    <span class="room-option__icon">‚öî</span>
                    <span class="room-option__title">Create Room</span>
                    <span class="room-option__desc">Start a new session</span>
                </button>
                
                <div class="room-divider">
                    <span>or</span>
                </div>
                
                <form class="join-form" id="join-form">
                    <div class="join-form__header">
                        <span class="room-option__icon">üîó</span>
                        <span class="room-option__title">Join Room</span>
                    </div>
                    <div class="join-form__field">
                        <input 
                            type="text" 
                            id="room-code" 
                            name="room-code" 
                            class="login-form__input join-form__input"
                            placeholder="XXXXX"
                            pattern="[A-Za-z0-9]{5}"
                            maxlength="5"
                        >
                        <button type="submit" class="join-form__submit">‚Üí</button>
                    </div>
                    <div class="login-form__error" id="join-error"></div>
                </form>
            </div>
        </section>
        
        <!-- Step 3b: Room Creation (with name) -->
        <section id="step-create-room" class="step">
            <form class="login-form" id="create-room-form">
                <h2 class="form-title">Create Your Room</h2>
                <div class="login-form__field">
                    <label for="room-name" class="login-form__label">Room Name</label>
                    <input 
                        type="text" 
                        id="room-name" 
                        name="room-name" 
                        class="login-form__input"
                        placeholder="My Session..."
                        maxlength="50"
                    >
                </div>
                
                <div class="login-form__error" id="create-room-error"></div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="btn-back-room">‚Üê Back</button>
                    <button type="submit" class="login-form__submit">
                        <span class="btn-text">Continue</span>
                        <span class="btn-loading">Creating...</span>
                    </button>
                </div>
            </form>
        </section>
        
        <!-- Step 4: Role Selection -->
        <section id="step-role" class="step">
            <div class="role-header">
                <span class="role-header__room" id="current-room-code"></span>
                <span class="role-header__label">Choose Your Role</span>
            </div>
            
            <div class="role-grid">
                <button class="role-card" data-role="Top">
                    <span class="role-card__icon">üëë</span>
                    <span class="role-card__name">Top</span>
                    <span class="role-card__desc">Lead the encounter</span>
                </button>
                
                <button class="role-card" data-role="Bottom">
                    <span class="role-card__icon">üåπ</span>
                    <span class="role-card__name">Bottom</span>
                    <span class="role-card__desc">Surrender control</span>
                </button>
                
                <button class="role-card" data-role="Observer">
                    <span class="role-card__icon">üëÅ</span>
                    <span class="role-card__name">Observer</span>
                    <span class="role-card__desc">Watch in silence</span>
                </button>
                
                <button class="role-card" data-role="Photographer">
                    <span class="role-card__icon">üì∏</span>
                    <span class="role-card__name">Photographer</span>
                    <span class="role-card__desc">Document the moment</span>
                </button>
                
                {# DEV ONLY: ActivityAdmin role card - only included if dev_mode is true #}
                {% if config.extra.dev_mode %}
                <button class="role-card role-card--dev" data-role="ActivityAdmin" id="role-activity-admin" style="display: none;">
                    <span class="role-card__icon">‚öôÔ∏è</span>
                    <span class="role-card__name">Admin</span>
                    <span class="role-card__desc">Manage activities</span>
                    <span class="role-card__dev-badge">DEV</span>
                </button>
                {% endif %}
            </div>
            
            <div class="login-form__error" id="role-error"></div>
        </section>
        
        <!-- Step 5: Room Lobby -->
        <section id="step-lobby" class="step">
            <div class="lobby">
                <div class="lobby__header">
                    <div class="lobby__room-info">
                        <span class="lobby__name" id="lobby-room-name"></span>
                        <span class="lobby__code" id="lobby-room-code"></span>
                    </div>
                    <button class="lobby__share" id="btn-share-code" title="Copy room code">
                        üìã
                    </button>
                </div>
                
                <div class="lobby__info">
                    <span class="lobby__label">Players in Room</span>
                </div>
                
                <div class="lobby__players" id="lobby-players">
                    <!-- Players will be inserted here -->
                </div>
                
                <!-- Available Activities -->
                <div class="lobby__section">
                    <div class="lobby__info">
                        <span class="lobby__label">Available Activities</span>
                        <span class="lobby__count" id="activities-count">0</span>
                    </div>
                    
                    <!-- Choose For Me Button -->
                    <button class="btn-dice-roll" id="btn-choose-for-me">
                        <span class="btn-dice-roll__icon">üé≤</span>
                        <span class="btn-dice-roll__text">Choose For Me</span>
                    </button>
                    
                    <!-- New Activities Toast -->
                    <div class="new-activities-toast hidden" id="new-activities-toast">
                        <span class="new-activities-toast__icon">‚ú®</span>
                        <span class="new-activities-toast__text">New activities unlocked!</span>
                        <button class="new-activities-toast__dismiss" id="btn-dismiss-new">√ó</button>
                    </div>
                    
                    <div class="lobby__activities" id="lobby-activities">
                        <p class="lobby__empty">Loading activities...</p>
                    </div>
                </div>
                
                <!-- Owner Controls (shown only to room owner) -->
                <div class="lobby__owner-controls hidden" id="owner-controls">
                    <h3 class="owner-controls__title">Room Owner Controls</h3>
                    
                    <div class="owner-controls__invite">
                        <button class="owner-controls__btn" id="btn-create-invite">
                            ‚úâÔ∏è Create Invitation
                        </button>
                        <div class="invite-result hidden" id="invite-result">
                            <input type="text" class="invite-token" id="invite-token-display" readonly>
                            <button class="btn-copy" id="btn-copy-invite">Copy</button>
                        </div>
                    </div>
                    
                    <button class="owner-controls__btn owner-controls__btn--danger" id="btn-close-room">
                        üö™ Close Room
                    </button>
                </div>
                
                <div class="lobby__actions">
                    <button class="lobby__leave" id="btn-leave-room">Leave Room</button>
                </div>
                
                {# DEV ONLY: Available Activities Debug Panel #}
                {% if config.extra.dev_mode %}
                <div class="debug-activities">
                    <details open>
                        <summary class="debug-activities__title">üêõ Debug: Available Activities</summary>
                        <div class="debug-activities__list" id="debug-activities-list">
                            <p class="debug-activities__empty">No activities loaded</p>
                        </div>
                    </details>
                </div>
                {% endif %}
            </div>
        </section>
        
        <!-- Step: Activity Detail View -->
        <section id="step-activity" class="step step-activity hidden">
            <div class="activity-detail">
                <div class="activity-detail__header">
                    <span class="activity-detail__category" id="activity-category">Category</span>
                    <span class="activity-detail__kind" id="activity-kind">Activity</span>
                </div>
                
                <h1 class="activity-detail__title" id="activity-title">Activity Name</h1>
                
                <div class="activity-detail__description" id="activity-description">
                    Activity description will appear here.
                </div>
                
                <div class="activity-detail__video hidden" id="activity-video-container">
                    <!-- Video embed or player will be inserted here -->
                </div>
                
                <div class="activity-detail__instructions hidden" id="activity-instructions-container">
                    <h3 class="activity-detail__section-title">Instructions</h3>
                    <div class="activity-detail__instructions-text" id="activity-instructions">
                        Instructions will appear here.
                    </div>
                </div>
                
                <div class="activity-detail__xp">
                    <span class="activity-detail__xp-reward" id="activity-xp-reward">
                        <span class="xp-icon">‚≠ê</span>
                        <span class="xp-value">+0 XP</span>
                    </span>
                </div>
                
                <!-- Viewing state: before activity is started -->
                <div class="activity-detail__actions" id="activity-actions-viewing">
                    <button class="activity-detail__btn activity-detail__btn--primary" id="btn-start-activity">
                        ‚ú® Do This Activity
                    </button>
                    <button class="activity-detail__btn activity-detail__btn--secondary" id="btn-go-back">
                        ‚Üê Go Back
                    </button>
                    <button class="activity-detail__btn activity-detail__btn--not-wanted" id="btn-not-wanted">
                        üö´ Don't show me this activity again
                    </button>
                </div>
                
                <!-- In Progress state: activity is being performed -->
                <div class="activity-detail__actions hidden" id="activity-actions-progress">
                    <div class="activity-detail__progress-indicator">
                        <span class="progress-icon">üî•</span>
                        <span class="progress-text">Activity in progress...</span>
                    </div>
                    <div class="activity-detail__participants" id="activity-participants">
                        <!-- Participant list will be inserted here -->
                    </div>
                    <button class="activity-detail__btn activity-detail__btn--success" id="btn-complete-activity">
                        ‚úÖ Completed This Activity
                    </button>
                    <button class="activity-detail__btn activity-detail__btn--danger" id="btn-cancel-activity">
                        ‚úï Cancel
                    </button>
                </div>
                
                <!-- Completion state: rating UI -->
                <div class="activity-detail__completion hidden" id="activity-completion">
                    <div class="activity-detail__celebration">
                        <span class="celebration-icon">üéâ</span>
                        <span class="celebration-text">Activity Completed!</span>
                    </div>
                    <div class="activity-detail__xp-earned" id="activity-xp-earned">
                        <span class="xp-earned-icon">‚≠ê</span>
                        <span class="xp-earned-value">+0 XP earned!</span>
                    </div>
                    <div class="activity-detail__rating">
                        <span class="rating-label">Rate this activity:</span>
                        <div class="rating-stars" id="rating-stars">
                            <button class="rating-star" data-rating="1">‚òÖ</button>
                            <button class="rating-star" data-rating="2">‚òÖ</button>
                            <button class="rating-star" data-rating="3">‚òÖ</button>
                            <button class="rating-star" data-rating="4">‚òÖ</button>
                            <button class="rating-star" data-rating="5">‚òÖ</button>
                        </div>
                    </div>
                    <button class="activity-detail__btn activity-detail__btn--primary" id="btn-back-to-lobby">
                        ‚Üê Back to Lobby
                    </button>
                </div>
            </div>
        </section>
        
        {# DEV ONLY: Admin Panel - only included if dev_mode is true #}
        {% if config.extra.dev_mode %}
        <section id="step-admin" class="step admin-panel">
            <div class="admin-header">
                <h2 class="admin-title">Activity Admin</h2>
                <span class="admin-badge">DEVELOPMENT</span>
                <button class="admin-back" id="admin-back">‚Üê Back</button>
            </div>
            
            <div class="admin-tabs">
                <button class="admin-tab admin-tab--active" data-tab="categories">Categories</button>
                <button class="admin-tab" data-tab="activities">Skills & Activities</button>
                <button class="admin-tab" data-tab="prerequisites">Prerequisites</button>
                <button class="admin-tab" data-tab="equipment">Equipment</button>
            </div>
            
            <div class="admin-content" id="tab-categories">
                <form class="admin-form" id="form-category">
                    <h3 class="admin-form__title">New Category</h3>
                    <div class="admin-form__row">
                        <input type="text" name="name" placeholder="Category name" class="admin-input" required>
                        <input type="number" name="display_order" placeholder="Order" class="admin-input admin-input--small" value="0">
                    </div>
                    <textarea name="description" placeholder="Description..." class="admin-textarea" required></textarea>
                    <button type="submit" class="admin-btn">Create Category</button>
                </form>
                <div class="admin-list" id="list-categories">
                    <p class="admin-list__empty">No categories yet</p>
                </div>
            </div>
            
            <div class="admin-content admin-content--hidden" id="tab-activities">
                <form class="admin-form" id="form-activity">
                    <h3 class="admin-form__title">New Activity / Skill</h3>
                    <div class="admin-form__row">
                        <div class="admin-field">
                            <label class="admin-label">Category</label>
                            <select name="category_id" class="admin-select" required>
                                <option value="">Select category...</option>
                            </select>
                        </div>
                        <div class="admin-field">
                            <label class="admin-label">Type</label>
                            <select name="kind" class="admin-select" required>
                                <option value="Activity">Activity</option>
                                <option value="Skill">Skill</option>
                            </select>
                        </div>
                    </div>
                    <input type="text" name="name" placeholder="Name" class="admin-input" required>
                    <textarea name="description" placeholder="Short description..." class="admin-textarea" required></textarea>
                    <textarea name="instructions" placeholder="Full instructions..." class="admin-textarea admin-textarea--tall" required></textarea>
                    <input type="url" name="video_url" placeholder="Video URL (optional)" class="admin-input">
                    <div class="admin-form__row">
                        <div class="admin-field">
                            <label class="admin-label">XP Required</label>
                            <input type="number" name="xp_required" class="admin-input" value="0" min="0">
                        </div>
                        <div class="admin-field">
                            <label class="admin-label">XP Reward</label>
                            <input type="number" name="xp_reward" class="admin-input" value="10" min="0">
                        </div>
                    </div>
                    <button type="submit" class="admin-btn">Create</button>
                </form>
                <div class="admin-list" id="list-activities">
                    <p class="admin-list__empty">No activities or skills yet</p>
                </div>
            </div>
            
            <div class="admin-content admin-content--hidden" id="tab-prerequisites">
                <form class="admin-form" id="form-prerequisite">
                    <h3 class="admin-form__title">Add Prerequisite</h3>
                    <div class="admin-form__row">
                        <div class="admin-field">
                            <label class="admin-label">Activity</label>
                            <select name="activity_id" class="admin-select" id="prereq-activity" required>
                                <option value="">Select activity...</option>
                            </select>
                        </div>
                        <span class="admin-arrow">requires ‚Üí</span>
                        <div class="admin-field">
                            <label class="admin-label">Prerequisite</label>
                            <select name="prerequisite_id" class="admin-select" id="prereq-prereq" required>
                                <option value="">Select prerequisite...</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="admin-btn">Add Prerequisite</button>
                </form>
                <div class="admin-list" id="list-prerequisites">
                    <p class="admin-list__empty">No prerequisites yet</p>
                </div>
            </div>
            
            <div class="admin-content admin-content--hidden" id="tab-equipment">
                <form class="admin-form" id="form-equipment">
                    <h3 class="admin-form__title">New Equipment</h3>
                    <input type="text" name="name" placeholder="Equipment name (e.g., Blindfold)" class="admin-input" required>
                    <textarea name="description" placeholder="Description (optional)..." class="admin-textarea"></textarea>
                    <button type="submit" class="admin-btn">Create Equipment</button>
                </form>
                <div class="admin-list" id="list-equipment">
                    <p class="admin-list__empty">No equipment yet</p>
                </div>
                
                <form class="admin-form admin-form--secondary" id="form-activity-equipment">
                    <h3 class="admin-form__title">Link Equipment to Activity</h3>
                    <div class="admin-form__row">
                        <div class="admin-field">
                            <label class="admin-label">Activity</label>
                            <select name="activity_id" class="admin-select" id="equip-activity" required>
                                <option value="">Select activity...</option>
                            </select>
                        </div>
                        <span class="admin-arrow">needs ‚Üí</span>
                        <div class="admin-field">
                            <label class="admin-label">Equipment</label>
                            <select name="equipment_id" class="admin-select" id="equip-equipment" required>
                                <option value="">Select equipment...</option>
                            </select>
                        </div>
                    </div>
                    <input type="text" name="notes" placeholder="Notes (optional, e.g., '2 required')" class="admin-input">
                    <button type="submit" class="admin-btn">Link Equipment</button>
                </form>
                <div class="admin-list" id="list-activity-equipment">
                    <p class="admin-list__empty">No equipment linked yet</p>
                </div>
            </div>
            
            <div class="login-form__error" id="admin-error"></div>
        </section>
        {% endif %}
        
        <!-- Connection Status -->
        <div class="connection-status" id="connection-status">
            <span class="connection-status__dot"></span>
            <span class="connection-status__text">Connecting...</span>
        </div>
    </div>
</main>

<!-- Preferences Modal -->
<div class="modal-overlay hidden" id="preferences-modal">
    <div class="modal preferences-modal">
        <div class="modal__header">
            <h2 class="modal__title" id="preferences-title">Activity Preferences</h2>
            <button class="modal__close" id="preferences-close" aria-label="Close">&times;</button>
        </div>
        <div class="modal__body">
            <p class="preferences-modal__subtitle">Select the categories you're interested in:</p>
            <div class="preferences-modal__categories" id="preferences-categories">
                <!-- Category checkboxes will be inserted here -->
            </div>
            <div class="preferences-modal__info">
                <p>üîí Categories with ID ‚â• 100 may contain adult-oriented content.</p>
                <p>‚ú® Changes are saved automatically.</p>
            </div>
        </div>
        <div class="modal__footer">
            <button class="btn btn--secondary" id="preferences-select-all">Select All</button>
            <button class="btn btn--secondary" id="preferences-select-none">Select None</button>
            <button class="btn btn--primary" id="preferences-done">Done</button>
        </div>
    </div>
</div>

<!-- QR Code Share Modal -->
<div class="modal-overlay hidden" id="qr-modal">
    <div class="modal qr-modal">
        <div class="modal__header">
            <h2 class="modal__title">üì≤ Share Room</h2>
            <button class="modal__close" id="qr-modal-close" aria-label="Close">&times;</button>
        </div>
        <div class="modal__body qr-modal__body">
            <div class="qr-modal__code" id="qr-code-container"></div>
            <p class="qr-modal__instructions">Scan this QR code to join the room</p>
            <div class="qr-modal__room-info">
                <span class="qr-modal__room-id" id="qr-room-id"></span>
            </div>
            <div class="qr-modal__url-container">
                <input type="text" class="qr-modal__url" id="qr-room-url" readonly>
                <button class="btn btn--secondary qr-modal__copy" id="qr-copy-url">üìã Copy</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script type="module" src="{{ get_url(path='js/app.js') }}"></script>
{% endblock %}
